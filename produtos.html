<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produtos | Painel Administrativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

    <style>
        :root { --cor-marrom-cta: #643f21; --cor-ouro-acento: #A58A5C; }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 0.75rem; border: 1px solid #e2e8f0; transition: all 0.2s; overflow: hidden; }
        .card:active { transform: scale(0.98); }
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--cor-marrom-cta); color: white; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-danger { background: #fee2e2; color: #991b1b; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 50; }
        .modal.visivel { display: flex; }
        .modal-content { background: white; width: 100%; height: 100%; display: flex; flex-direction: column; }
        @media (min-width: 768px) { .modal-content { width: 800px; height: auto; max-height: 90vh; border-radius: 1rem; } }
        .tab-button { transition: all 0.2s; }
        .tab-panel.hidden { display: none; }
        .imagem-preview { position: relative; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb; }
        .gallery-picker-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .gallery-picker-item { aspect-ratio: 1; position: relative; cursor: pointer; border-radius: 8px; overflow: hidden; border: 2px solid transparent; }
        .gallery-picker-item:hover { border-color: var(--cor-ouro-acento); }
        .gallery-picker-item img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body class="pb-20 min-h-screen">

    <header class="bg-white shadow-md sticky top-0 z-40 px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <a href="dashboard.html" class="text-gray-600 text-xl"><i class="fa-solid fa-arrow-left"></i></a>
            <h1 class="font-allura text-3xl text-gray-800">Produtos & Kits</h1>
        </div>
        <button onclick="abrirModalProduto()" class="btn btn-primary text-sm shadow-lg">
            <i class="fa-solid fa-plus mr-2"></i><span class="hidden sm:inline">Novo</span>
        </button>
    </header>

    <main class="max-w-7xl mx-auto p-4">
        <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-100 mb-6">
            <div class="flex flex-col sm:flex-row gap-3">
                <div class="relative flex-grow">
                    <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
                    <input type="text" id="search-input" placeholder="Buscar produto..." class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-[--cor-ouro-acento]">
                </div>
                <select id="filter-category" class="w-full sm:w-auto border border-gray-200 rounded-lg px-3 py-2 bg-white text-sm focus:outline-none focus:border-[--cor-ouro-acento]">
                    <option value="all">Todas as Categorias</option>
                    <option value="kit">Kits / Conjuntos</option>
                    <option value="mesa_posta">Mesa Posta</option>
                    <option value="vestido">Vestidos</option>
                    <option value="conjunto">Conjuntos</option>
                    <option value="calca">Calças</option>
                    <option value="camisa">Camisas</option>
                </select>
            </div>
        </div>

        <div id="loading-state" class="text-center py-12">
            <div class="w-8 h-8 border-4 border-gray-200 border-t-[--cor-ouro-acento] rounded-full animate-spin mx-auto mb-2"></div>
            <p class="text-gray-500 text-sm">Carregando...</p>
        </div>

        <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
        <div id="empty-state" class="hidden text-center py-12"><p class="text-gray-500">Nenhum produto encontrado.</p></div>
    </main>

    <!-- MODAL DE PRODUTO/KIT -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center p-4 border-b bg-white">
                <h2 id="modal-title" class="text-2xl font-semibold text-gray-800">Novo Produto</h2>
                <button onclick="fecharModalProduto()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>

            <form id="product-form" class="flex-1 overflow-y-auto flex flex-col">
                <input type="hidden" id="product-id">

                <div class="border-b border-gray-200 bg-white px-4">
                    <nav class="flex gap-6 overflow-x-auto no-scrollbar">
                        <button type="button" class="tab-button py-3 border-b-2 border-[--cor-marrom-cta] font-medium text-sm text-[--cor-marrom-cta] whitespace-nowrap" data-tab="basic">Básico</button>
                        <button type="button" id="tab-btn-kit" class="tab-button hidden py-3 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="kit-composition">Composição do Kit</button>
                        <button type="button" class="tab-button py-3 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="colors">Cores</button>
                        <button type="button" class="tab-button py-3 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="images">Imagens</button>
                    </nav>
                </div>

                <div id="tab-content" class="flex-1 p-4 bg-gray-50 overflow-y-auto">
                    
                    <!-- Aba: Básico -->
                    <div id="tab-basic" class="tab-panel active space-y-6">
                        <div class="grid grid-cols-1 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Produto/Kit *</label>
                                <input type="text" id="product-name" required class="w-full border border-gray-300 rounded-md p-2">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Preço Venda (R$) *</label>
                                    <input type="number" step="0.01" id="product-price" required class="w-full border border-gray-300 rounded-md p-2">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Categoria *</label>
                                    <select id="product-category" required class="w-full border border-gray-300 rounded-md p-2 bg-white" onchange="toggleKitTab()">
                                        <option value="vestido">Vestido</option>
                                        <option value="mesa_posta">Mesa Posta (Peça Avulsa)</option>
                                        <option value="kit">Kit / Conjunto (Mesa Posta)</option>
                                        <option value="conjunto">Conjunto (Roupas)</option>
                                        <option value="outros">Outros</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Descrição do Kit/Produto</label>
                                <textarea id="product-description" rows="3" class="w-full border border-gray-300 rounded-md p-2"></textarea>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-sm text-gray-700">Status</label><select id="product-status" class="w-full border rounded-md p-2"><option value="active">Ativo</option><option value="inactive">Inativo</option></select></div>
                                <div><label class="text-sm text-gray-700">Coleção</label><select id="product-collection" class="w-full border rounded-md p-2"><option value="">Sem coleção</option></select></div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba: Composição do Kit (NOVO) -->
                    <div id="tab-kit-composition" class="tab-panel hidden space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-4">
                            <h4 class="font-bold text-blue-800 mb-2 text-sm"><i class="fa-solid fa-puzzle-piece mr-2"></i>Montar Kit</h4>
                            <p class="text-xs text-blue-600 mb-4">Selecione peças avulsas para compor este kit. O cliente escolherá a cor do kit na hora da compra.</p>
                            
                            <div class="flex gap-2 mb-2">
                                <select id="kit-component-select" class="flex-1 text-sm border rounded p-2 bg-white"></select>
                                <input type="number" id="kit-component-qty" value="1" min="1" class="w-20 text-sm border rounded p-2" placeholder="Qtd">
                                <button type="button" onclick="addKitComponent()" class="btn btn-primary text-xs px-4">Adicionar</button>
                            </div>
                        </div>

                        <div class="bg-white border rounded-lg overflow-hidden">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                                    <tr><th class="p-3">Peça</th><th class="p-3 text-center">Qtd</th><th class="p-3 text-right">Unit.</th><th class="p-3"></th></tr>
                                </thead>
                                <tbody id="kit-components-list" class="divide-y divide-gray-100"></tbody>
                                <tfoot class="bg-gray-50 font-bold">
                                    <tr>
                                        <td colspan="2" class="p-3 text-right">Total Real:</td>
                                        <td class="p-3 text-right text-gray-500 line-through" id="kit-total-real">R$ 0,00</td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td colspan="2" class="p-3 text-right text-[--cor-marrom-cta]">Preço do Kit:</td>
                                        <td class="p-3 text-right text-[--cor-marrom-cta]" id="kit-price-display">R$ 0,00</td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td colspan="4" class="p-2 text-center text-xs text-green-600" id="kit-economy-display"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- Aba: Cores -->
                    <div id="tab-colors" class="tab-panel hidden space-y-6">
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <h4 class="font-medium text-gray-800 mb-4">Opções de Cor</h4>
                            <p class="text-xs text-gray-500 mb-4">Para Kits, adicione as cores disponíveis para o conjunto inteiro.</p>
                            <div class="grid grid-cols-1 gap-4">
                                <div class="flex gap-2 items-center">
                                    <input type="color" id="new-color-hex-text" class="h-10 w-12 border rounded cursor-pointer p-0 bg-transparent">
                                    <input type="text" id="new-color-name" placeholder="Nome (Ex: Azul Marinho)" class="w-full border border-gray-300 rounded-md p-2">
                                </div>
                                <div class="flex gap-2">
                                    <input type="number" id="new-color-quantity" placeholder="Estoque" class="w-24 border border-gray-300 rounded-md p-2">
                                    <button type="button" onclick="adicionarCor()" class="btn btn-primary flex-1">Adicionar</button>
                                </div>
                            </div>
                        </div>
                        <div id="colors-list" class="space-y-3"></div>
                    </div>

                    <!-- Aba: Imagens -->
                    <div id="tab-images" class="tab-panel hidden space-y-6">
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <button type="button" onclick="document.getElementById('file-upload').click()" class="btn btn-secondary flex flex-col py-4 border-2 border-dashed border-gray-300 h-full">
                                    <i class="fa-solid fa-cloud-arrow-up text-2xl text-[--cor-ouro-acento]"></i>
                                    <span class="text-xs font-medium">Upload</span>
                                    <input type="file" id="file-upload" accept="image/*" class="hidden" onchange="handleFileUpload(this)">
                                </button>
                                <button type="button" onclick="abrirSeletorGaleria()" class="btn btn-secondary flex flex-col py-4 border-2 border-dashed border-gray-300 h-full">
                                    <i class="fa-solid fa-images text-2xl text-[--cor-ouro-acento]"></i>
                                    <span class="text-xs font-medium">Galeria</span>
                                </button>
                            </div>
                            <div class="flex gap-2 pt-2">
                                <input type="url" id="new-image-url" placeholder="Link direto..." class="w-full border rounded-md p-2 text-sm">
                                <button type="button" onclick="adicionarImagemUrl()" class="btn btn-secondary px-3"><i class="fa-solid fa-plus"></i></button>
                            </div>
                        </div>
                        <div id="selected-images-preview" class="grid grid-cols-3 gap-3"></div>
                    </div>
                </div>

                <div class="flex justify-between items-center p-4 bg-white border-t mt-auto z-10 shadow-inner">
                    <button type="button" id="delete-product-btn" onclick="deletarProduto()" class="btn-danger px-4 py-2 hidden rounded-md text-sm">Excluir</button>
                    <div class="flex gap-4 ml-auto">
                        <button type="button" onclick="fecharModalProduto()" class="btn-secondary px-4 py-2 rounded-md text-sm">Cancelar</button>
                        <button type="submit" id="save-product-btn" onclick="salvarProduto(event)" class="btn-primary px-6 py-2 rounded-md text-sm">Salvar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Galeria -->
    <div id="gallery-picker-modal" class="modal" style="z-index: 60;">
        <div class="modal-content" style="max-width: 500px; height: 80vh;">
            <div class="flex justify-between items-center p-4 border-b bg-white">
                <h3 class="text-lg font-semibold">Galeria</h3>
                <button onclick="fecharSeletorGaleria()" class="text-gray-500 text-2xl">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 bg-gray-50"><div id="gallery-picker-grid" class="gallery-picker-grid"></div></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCzB4_YotWCPVh1yaqWkhbB4LypPQYvV4U",
            authDomain: "site-lamed.firebaseapp.com",
            databaseURL: "https://site-lamed-default-rtdb.firebaseio.com",
            projectId: "site-lamed",
            storageBucket: "site-lamed.firebasestorage.app",
            messagingSenderId: "862756160215",
            appId: "1:862756160215:web:d0fded233682bf93eaa692",
            measurementId: "G-BL1G961PGT"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        let produtos = [];
        let selectedProductImages = [];
        let productColors = [];
        let kitComponents = []; // Array para armazenar componentes do kit
        let allProductsList = []; // Lista completa para o dropdown do kit
        let collectionsMap = {};

        const elementos = {
            productModal: document.getElementById('product-modal'),
            galleryModal: document.getElementById('gallery-picker-modal')
        };

        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(user => {
                if (!user) window.location.href = 'login-admin.html';
                else {
                    carregarColecoes();
                    carregarDados();
                }
            });

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });

            // Atualizar cálculos do kit quando o preço do produto mudar
            document.getElementById('product-price').addEventListener('input', atualizarCalculosKit);
            
            // Filtros
            document.getElementById('search-input').addEventListener('input', filtrarProdutos);
            document.getElementById('filter-category').addEventListener('change', filtrarProdutos);
        });

        // --- DADOS ---
        async function carregarColecoes() {
            const snap = await db.collection('colecoes').get();
            const select = document.getElementById('product-collection');
            select.innerHTML = '<option value="">Sem coleção</option>';
            snap.forEach(doc => {
                const c = doc.data();
                collectionsMap[doc.id] = c.nome;
                select.innerHTML += `<option value="${doc.id}">${c.nome}</option>`;
            });
        }

        function carregarDados() {
            db.collection('pecas').orderBy('createdAt', 'desc').onSnapshot(snap => {
                produtos = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allProductsList = produtos; // Backup para o seletor de kits
                renderizarGrid(produtos);
                popularSelectComponentes();
                document.getElementById('loading-state').style.display = 'none';
            });
        }

        function popularSelectComponentes() {
            const select = document.getElementById('kit-component-select');
            select.innerHTML = '<option value="">Selecione uma peça...</option>';
            // Filtrar apenas peças individuais (não kits) para evitar loops
            const pecasIndividuais = allProductsList.filter(p => p.categoria !== 'kit');
            
            pecasIndividuais.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = `${p.nome} (R$ ${p.preco})`;
                opt.dataset.price = p.preco;
                opt.dataset.name = p.nome;
                select.appendChild(opt);
            });
        }

        function renderizarGrid(lista) {
            const grid = document.getElementById('products-grid');
            const empty = document.getElementById('empty-state');
            grid.innerHTML = '';
            if (lista.length === 0) { empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');

            lista.forEach(p => {
                const img = (p.imagens && p.imagens[0]) ? p.imagens[0] : 'https://placehold.co/300x400/eee/ccc?text=Sem+Imagem';
                const stockTotal = p.cores ? p.cores.reduce((acc, c) => acc + (parseInt(c.quantidade) || 0), 0) : 0;
                const colName = p.colecaoId ? (collectionsMap[p.colecaoId] || 'Geral') : 'Geral';
                const isKit = p.categoria === 'kit';

                grid.innerHTML += `
                    <div class="card cursor-pointer group relative" onclick="abrirModalProduto('${p.id}')">
                        <div class="relative h-48 bg-gray-50 border-b border-gray-100 overflow-hidden">
                            <img src="${img}" class="w-full h-full object-cover">
                            ${isKit ? '<div class="absolute top-2 right-2 bg-purple-600 text-white text-[10px] px-2 py-1 rounded font-bold uppercase tracking-wide shadow">KIT</div>' : 
                            `<div class="absolute top-2 right-2 text-xs bg-white/90 px-2 py-1 rounded font-bold shadow-sm text-gray-700">${stockTotal} un.</div>`}
                        </div>
                        <div class="p-4">
                            <h3 class="font-semibold text-gray-800 text-sm truncate mb-1">${p.nome}</h3>
                            <p class="text-[10px] text-gray-500 uppercase tracking-wider mb-2">${isKit ? 'Kit Pronto' : p.categoria}</p>
                            <span class="font-bold text-[--cor-marrom-cta]">R$ ${p.preco}</span>
                        </div>
                    </div>
                `;
            });
        }

        function filtrarProdutos() {
            const termo = document.getElementById('search-input').value.toLowerCase();
            const cat = document.getElementById('filter-category').value;
            const filtrados = produtos.filter(p => {
                const matchTermo = p.nome.toLowerCase().includes(termo);
                const matchCat = cat === 'all' || p.categoria === cat;
                return matchTermo && matchCat;
            });
            renderizarGrid(filtrados);
        }

        // --- LÓGICA DE KIT ---
        function toggleKitTab() {
            const category = document.getElementById('product-category').value;
            const tabBtn = document.getElementById('tab-btn-kit');
            if (category === 'kit') {
                tabBtn.classList.remove('hidden');
                // Se estiver criando um kit, abre a aba composição
                if(document.getElementById('tab-basic').classList.contains('active')) {
                    // Opcional: switchTab('kit-composition'); 
                }
            } else {
                tabBtn.classList.add('hidden');
                if (document.getElementById('tab-kit-composition').classList.contains('active')) {
                    switchTab('basic');
                }
            }
        }

        function addKitComponent() {
            const select = document.getElementById('kit-component-select');
            const id = select.value;
            if(!id) return alert("Selecione uma peça.");
            
            const qty = parseInt(document.getElementById('kit-component-qty').value);
            const name = select.options[select.selectedIndex].dataset.name;
            const price = parseFloat(select.options[select.selectedIndex].dataset.price);

            // Verifica se já existe e soma
            const existing = kitComponents.find(c => c.id === id);
            if(existing) {
                existing.quantidade += qty;
            } else {
                kitComponents.push({ id, nome: name, quantidade: qty, precoOriginal: price });
            }
            
            renderKitComponents();
            select.value = "";
            document.getElementById('kit-component-qty').value = 1;
        }

        function removeKitComponent(idx) {
            kitComponents.splice(idx, 1);
            renderKitComponents();
        }

        function renderKitComponents() {
            const tbody = document.getElementById('kit-components-list');
            tbody.innerHTML = '';
            
            let totalReal = 0;

            kitComponents.forEach((comp, idx) => {
                const subtotal = comp.quantidade * comp.precoOriginal;
                totalReal += subtotal;
                
                tbody.innerHTML += `
                    <tr class="border-b border-gray-50 last:border-0 hover:bg-gray-50">
                        <td class="p-3 font-medium text-gray-700">${comp.nome}</td>
                        <td class="p-3 text-center">${comp.quantidade}</td>
                        <td class="p-3 text-right text-xs text-gray-500">R$ ${subtotal.toFixed(2)}</td>
                        <td class="p-3 text-right">
                            <button type="button" onclick="removeKitComponent(${idx})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });

            document.getElementById('kit-total-real').textContent = `R$ ${totalReal.toFixed(2)}`;
            document.getElementById('kit-total-real').dataset.value = totalReal; // Guardar valor numérico
            atualizarCalculosKit();
        }

        function atualizarCalculosKit() {
            const precoKit = parseFloat(document.getElementById('product-price').value) || 0;
            const totalReal = parseFloat(document.getElementById('kit-total-real').dataset.value) || 0;
            
            document.getElementById('kit-price-display').textContent = `R$ ${precoKit.toFixed(2)}`;
            
            if (totalReal > 0 && precoKit > 0) {
                const economia = totalReal - precoKit;
                if (economia > 0) {
                    document.getElementById('kit-economy-display').innerHTML = `⭐ Economia de R$ ${economia.toFixed(2)}`;
                } else {
                    document.getElementById('kit-economy-display').innerHTML = ``;
                }
            }
        }

        // --- Modal Logic ---
        function abrirModalProduto(productId = null) {
            resetModalProduto();
            if (productId) {
                const produto = produtos.find(p => p.id === productId);
                preencherFormularioProduto(produto);
                document.getElementById("modal-title").textContent = "Editar";
                document.getElementById("delete-product-btn").classList.remove("hidden");
            } else {
                document.getElementById("modal-title").textContent = "Novo Produto";
                document.getElementById("delete-product-btn").classList.add("hidden");
            }
            elementos.productModal.classList.add("visivel");
            switchTab("basic");
        }

        function fecharModalProduto() { elements.productModal.classList.remove("visivel"); }

        function resetModalProduto() {
            document.getElementById("product-form").reset();
            document.getElementById("product-id").value = "";
            selectedProductImages = [];
            productColors = [];
            kitComponents = [];
            atualizarPreviewImagensSelecionadas();
            atualizarListaCores();
            renderKitComponents();
            toggleKitTab(); // Resetar visibilidade da aba
        }

        function preencherFormularioProduto(produto) {
            document.getElementById("product-id").value = produto.id;
            document.getElementById("product-name").value = produto.nome;
            document.getElementById("product-price").value = produto.preco;
            document.getElementById("product-description").value = produto.descricao || '';
            document.getElementById("product-category").value = produto.categoria;
            document.getElementById("product-status").value = produto.status || 'active';
            if (produto.colecaoId) document.getElementById("product-collection").value = produto.colecaoId;

            selectedProductImages = [...(produto.imagens || [])];
            atualizarPreviewImagensSelecionadas();
            productColors = [...(produto.cores || [])];
            atualizarListaCores();
            
            // Carregar Kit
            if (produto.categoria === 'kit' && produto.componentes) {
                kitComponents = [...produto.componentes];
                renderKitComponents();
            }
            toggleKitTab();
        }

        async function salvarProduto(event) {
            event.preventDefault();
            const id = document.getElementById("product-id").value;
            const nome = document.getElementById("product-name").value.trim();
            const preco = parseFloat(document.getElementById("product-price").value);
            const categoria = document.getElementById("product-category").value;

            if (!nome || isNaN(preco)) { alert("Preencha nome e preço."); return; }

            const data = {
                nome, preco,
                descricao: document.getElementById("product-description").value.trim(),
                categoria,
                status: document.getElementById("product-status").value,
                colecaoId: document.getElementById("product-collection").value || null,
                imagens: selectedProductImages,
                cores: productColors,
                updatedAt: new Date()
            };

            // Se for Kit, salva os componentes
            if (categoria === 'kit') {
                data.componentes = kitComponents;
            }

            try {
                const btn = document.getElementById('save-product-btn');
                btn.disabled = true; btn.textContent = 'Salvando...';
                
                if (id) {
                    await db.collection("pecas").doc(id).update(data);
                } else {
                    data.createdAt = new Date();
                    await db.collection("pecas").add(data);
                }
                fecharModalProduto();
            } catch (e) {
                alert("Erro: " + e.message);
            } finally {
                const btn = document.getElementById('save-product-btn');
                btn.disabled = false; btn.textContent = 'Salvar';
            }
        }

        async function deletarProduto() {
            const id = document.getElementById("product-id").value;
            if (!id || !confirm("Tem certeza?")) return;
            await db.collection("pecas").doc(id).delete();
            fecharModalProduto();
        }

        // --- Cores e Imagens (Lógica Existente) ---
        function adicionarCor() {
            const nome = document.getElementById("new-color-name").value.trim();
            const hex = document.getElementById("new-color-hex-text").value.trim();
            const quantidade = parseInt(document.getElementById("new-color-quantity").value) || 0;
            if (!nome) { alert("Digite o nome da cor."); return; }
            productColors.push({ nome, hex, quantidade });
            document.getElementById("new-color-name").value = '';
            atualizarListaCores();
        }

        function atualizarListaCores() {
            const container = document.getElementById("colors-list");
            container.innerHTML = productColors.map((cor, i) => `
                <div class="card p-4 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="color-preview" style="background:${cor.hex}"></div>
                        <div><div class="font-medium text-sm">${cor.nome}</div><div class="text-xs text-gray-500">Estoque: ${cor.quantidade}</div></div>
                    </div>
                    <button type="button" onclick="removerCor(${i})" class="text-red-500"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join("");
        }
        window.removerCor = (idx) => { productColors.splice(idx, 1); atualizarListaCores(); }

        function adicionarImagemUrl() {
            const url = document.getElementById('new-image-url').value;
            if (url) { selectedProductImages.push(url); document.getElementById('new-image-url').value = ''; atualizarPreviewImagensSelecionadas(); }
        }

        async function handleFileUpload(input) {
            const file = input.files[0];
            if(!file) return;
            try {
                const ref = storage.ref(`produtos/${Date.now()}_${file.name}`);
                await ref.put(file);
                selectedProductImages.push(await ref.getDownloadURL());
                atualizarPreviewImagensSelecionadas();
            } catch(e) { alert("Erro upload."); }
        }

        async function abrirSeletorGaleria() {
            elementos.galleryModal.classList.add('visivel');
            const grid = document.getElementById('gallery-picker-grid');
            grid.innerHTML = 'Carregando...';
            const snap = await db.collection('galeria').orderBy('dataUpload', 'desc').limit(20).get();
            grid.innerHTML = '';
            snap.forEach(doc => {
                const img = doc.data();
                const item = document.createElement('div');
                item.className = 'gallery-picker-item';
                item.innerHTML = `<img src="${img.url}">`;
                item.onclick = () => { selectedProductImages.push(img.url); atualizarPreviewImagensSelecionadas(); fecharSeletorGaleria(); };
                grid.appendChild(item);
            });
        }
        function fecharSeletorGaleria() { elementos.galleryModal.classList.remove('visivel'); }

        function atualizarPreviewImagensSelecionadas() {
            const container = document.getElementById("selected-images-preview");
            container.innerHTML = selectedProductImages.map((url, i) => `
                <div class="imagem-preview relative aspect-square bg-gray-100">
                    <img src="${url}" class="w-full h-full object-cover">
                    <button type="button" onclick="removerImagem(${i})" class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center">×</button>
                </div>
            `).join("");
        }
        window.removerImagem = (i) => { selectedProductImages.splice(i, 1); atualizarPreviewImagensSelecionadas(); }

        function switchTab(tab) {
            document.querySelectorAll('.tab-button').forEach(b => {
                b.classList.remove('border-[--cor-marrom-cta]', 'text-[--cor-marrom-cta]');
                b.classList.add('border-transparent', 'text-gray-500');
                if (b.dataset.tab === tab) {
                    b.classList.remove('border-transparent', 'text-gray-500');
                    b.classList.add('border-[--cor-marrom-cta]', 'text-[--cor-marrom-cta]');
                }
            });
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
        }
    </script>
</body>
</html>
